version: '3.8'

services:
  # Box项目的后端服务
  box-backend:
    image: box-backend:latest
    container_name: box-backend
    pull_policy: never
    restart: unless-stopped
    environment:
      # Production: DEBUG关闭，使用环境变量管理密钥
      - DEBUG=False
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django-insecure-xu+de!4r0eb^o9chcp%-bn@ke-r0935n6-6um_qt%&y27p32oi}
      - ALLOWED_HOSTS=localhost,127.0.0.1,box-backend,nginx,thezbr.com,www.thezbr.com,3.107.17.208
      - APPEND_SLASH=False
    networks:
      - app-network

  # P2P项目的后端服务
  p2p-backend:
    image: p2p-backend
    container_name: p2p-backend
    restart: unless-stopped
    environment:
      - ASPNETCORE_ENVIRONMENT=Production
      - ASPNETCORE_URLS=http://+:5235
      # Production: 允许生产域名 + 本地开发
      - ALLOWED_ORIGINS=https://thezbr.com,https://www.thezbr.com,http://localhost:3000
    networks:
      - app-network

  # Student项目的后端服务
  student-backend:
    image: student-backend
    container_name: student-backend
    restart: unless-stopped
    environment:
      # Production: DEBUG关闭，使用环境变量管理密钥
      - DEBUG=False
      - DJANGO_SECRET_KEY=${DJANGO_SECRET_KEY:-django-insecure-@%babz@u@5_=&75(em@s+m1&v0v#r(b5eyo*z4jq#n1&uw+7g=}
      - ALLOWED_HOSTS=localhost,127.0.0.1,student-backend,nginx,thezbr.com,www.thezbr.com,3.107.17.208
      - JWT_SECRET_KEY=${JWT_SECRET_KEY:-your-super-secret-jwt-key-change-this-in-production-12345}
    networks:
      - app-network

  # Nginx服务 - 处理所有应用的路由
  nginx:
    image: nginx:alpine
    container_name: integrated-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/conf.d/default.conf
      - ./box/box_show/build:/usr/share/nginx/html/box
      - ./P2P/p2p-client/build:/usr/share/nginx/html/p2p
      - ./Student_Enroll_Grade_System/front_end/dist:/usr/share/nginx/html
      - ./test.html:/usr/share/nginx/html/test.html
      - /etc/letsencrypt:/etc/letsencrypt:ro
    depends_on:
      - box-backend
      - p2p-backend
      - student-backend
    networks:
      - app-network

networks:
  app-network:
    driver: bridge
