# ============================================
# 安全的Nginx配置 - 生产+开发环境
# 服务器: 3.107.17.208 (thezbr.com)
# ============================================

# 速率限制配置（防止暴力破解邀请码）
limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;
limit_req_zone $binary_remote_addr zone=p2p_limit:10m rate=20r/s;

# 连接数限制（每个IP最多20个并发连接）
limit_conn_zone $binary_remote_addr zone=conn_limit:10m;

# ==========================================
# HTTP服务器 - 自动重定向到HTTPS
# ==========================================
server {
    listen 80;
    server_name thezbr.com www.thezbr.com 3.107.17.208;

    # 将所有HTTP请求重定向到HTTPS
    return 301 https://$server_name$request_uri;
}

# ==========================================
# HTTPS服务器 - 主配置
# ==========================================
server {
    listen 443 ssl http2;
    server_name thezbr.com www.thezbr.com;

    # ==========================================
    # SSL证书配置
    # ==========================================
    ssl_certificate /etc/letsencrypt/live/thezbr.com/fullchain.pem;
    ssl_certificate_key /etc/letsencrypt/live/thezbr.com/privkey.pem;

    # SSL安全配置（推荐设置）
    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers 'ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384';
    ssl_prefer_server_ciphers off;
    ssl_session_cache shared:SSL:10m;
    ssl_session_timeout 10m;

    # ==========================================
    # 安全头配置
    # ==========================================
    # HSTS - 强制浏览器使用HTTPS（1年有效期）
    add_header Strict-Transport-Security "max-age=31536000; includeSubDomains" always;

    # 防止点击劫持
    add_header X-Frame-Options "SAMEORIGIN" always;

    # 防止MIME类型嗅探
    add_header X-Content-Type-Options "nosniff" always;

    # XSS保护
    add_header X-XSS-Protection "1; mode=block" always;

    # Referrer策略
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;

    # CSP头（内容安全策略 - 防XSS攻击）
    add_header Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' wss://thezbr.com https://thezbr.com http://localhost:* ws://localhost:*; frame-ancestors 'self';" always;

    # 全局连接数限制
    limit_conn conn_limit 20;

    # ==========================================
    # 前端静态文件
    # ==========================================

    # 根路径 - Student 项目前端
    location = / {
        root /usr/share/nginx/html;
        index index.html;
    }

    # 测试页面
    location = /test {
        root /usr/share/nginx/html;
        try_files /test.html =404;
    }

    # Student 项目子路径
    location ~ ^/(?!box|p2p|api|swagger|p2phub|test)(.*)$ {
        root /usr/share/nginx/html;
        try_files $uri $uri/ /index.html;
    }

    # Box 项目主页
    location = /box {
        return 301 /box/;
    }

    location = /box/ {
        alias /usr/share/nginx/html/box/;
        try_files index.html =404;
    }

    # Box 项目路径
    location /box/ {
        alias /usr/share/nginx/html/box/;
        try_files $uri $uri/ /box/index.html;
    }

    # P2P 项目主页
    location = /p2p {
        return 301 /p2p/;
    }

    location = /p2p/ {
        alias /usr/share/nginx/html/p2p/;
        try_files index.html =404;
    }

    # P2P 项目路径
    location /p2p/ {
        alias /usr/share/nginx/html/p2p/;
        try_files $uri $uri/ /p2p/index.html;
    }

    # ==========================================
    # 静态资源配置
    # ==========================================

    # Box 静态资源
    location ~ ^/box/static/(.*)$ {
        alias /usr/share/nginx/html/box/static/$1;
    }

    # Box 静态文件
    location ~ ^/box/(manifest.json|logo192.png|logo512.png|1.ico|favicon.ico)$ {
        alias /usr/share/nginx/html/box/$1;
    }

    # P2P 静态资源
    location ~ ^/p2p/static/(.*)$ {
        alias /usr/share/nginx/html/p2p/static/$1;
    }

    # P2P 静态文件
    location ~ ^/p2p/(manifest.json|logo192.png|logo512.png|favicon.ico)$ {
        alias /usr/share/nginx/html/p2p/$1;
    }

    # Student 静态资源
    location ~ ^/assets/(.*)$ {
        alias /usr/share/nginx/html/assets/$1;
    }

    # Student 静态文件
    location ~ ^/(manifest.json|favicon.ico)$ {
        root /usr/share/nginx/html;
    }

    # ==========================================
    # API端点（带CORS白名单保护 + 速率限制）
    # ==========================================

    # Student API转发
    location /api/student/ {
        # 速率限制：每秒10个请求，允许突发20个
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;

        proxy_pass http://student-backend:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS白名单配置（生产域名 + 本地开发）
        set $cors_origin "";

        # 允许生产域名
        if ($http_origin ~* ^https?://(www\.)?thezbr\.com$) {
            set $cors_origin $http_origin;
        }

        # 允许本地开发（localhost任意端口）
        if ($http_origin ~* ^http://localhost(:[0-9]+)?$) {
            set $cors_origin $http_origin;
        }

        # 允许本地开发（127.0.0.1任意端口）
        if ($http_origin ~* ^http://127\.0\.0\.1(:[0-9]+)?$) {
            set $cors_origin $http_origin;
        }

        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization' always;

        # 处理OPTIONS预检请求
        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin;
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH';
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
            add_header 'Access-Control-Max-Age' 86400;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }

    # Box API转发
    location /api/box/ {
        # 速率限制
        limit_req zone=api_limit burst=20 nodelay;
        limit_req_status 429;

        proxy_pass http://box-backend:8000/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;

        # CORS白名单配置
        set $cors_origin "";

        if ($http_origin ~* ^https?://(www\.)?thezbr\.com$) {
            set $cors_origin $http_origin;
        }

        if ($http_origin ~* ^http://localhost(:[0-9]+)?$) {
            set $cors_origin $http_origin;
        }

        if ($http_origin ~* ^http://127\.0\.0\.1(:[0-9]+)?$) {
            set $cors_origin $http_origin;
        }

        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization' always;

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin;
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
            add_header 'Access-Control-Max-Age' 86400;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }

    # P2P API转发（更高的速率限制，因为文件传输频繁）
    location /api/p2p/ {
        # P2P需要更高频率：每秒20个请求，允许突发50个
        limit_req zone=p2p_limit burst=50 nodelay;
        limit_req_status 429;

        proxy_pass http://p2p-backend:5235/api/p2p/;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # CORS白名单配置
        set $cors_origin "";

        if ($http_origin ~* ^https?://(www\.)?thezbr\.com$) {
            set $cors_origin $http_origin;
        }

        if ($http_origin ~* ^http://localhost(:[0-9]+)?$) {
            set $cors_origin $http_origin;
        }

        if ($http_origin ~* ^http://127\.0\.0\.1(:[0-9]+)?$) {
            set $cors_origin $http_origin;
        }

        add_header 'Access-Control-Allow-Origin' $cors_origin always;
        add_header 'Access-Control-Allow-Credentials' 'true' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization' always;

        if ($request_method = 'OPTIONS') {
            add_header 'Access-Control-Allow-Origin' $cors_origin;
            add_header 'Access-Control-Allow-Credentials' 'true';
            add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE';
            add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization';
            add_header 'Access-Control-Max-Age' 86400;
            add_header 'Content-Type' 'text/plain; charset=utf-8';
            add_header 'Content-Length' 0;
            return 204;
        }
    }

    # ==========================================
    # P2P WebSocket连接（SignalR）
    # ==========================================
    location /p2phub {
        # WebSocket连接不应有严格的速率限制（会导致连接断开）
        # 但保留连接数限制防止DoS攻击

        proxy_pass http://p2p-backend:5235/p2phub;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_cache_bypass $http_upgrade;

        # WebSocket超时设置（1小时）
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }

    # ==========================================
    # Swagger文档
    # ==========================================

    # Box Swagger
    location /swagger/box/ {
        proxy_pass http://box-backend:8000/swagger/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Student Swagger
    location /swagger/student/ {
        proxy_pass http://student-backend:8000/swagger/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # ==========================================
    # 错误页面
    # ==========================================

    # 速率限制触发时返回429错误
    error_page 429 /429.html;
    location = /429.html {
        internal;
        default_type text/html;
        return 429 '<html><head><meta charset="utf-8"><title>请求过于频繁</title></head><body style="font-family: Arial, sans-serif; text-align: center; padding: 50px;"><h1>⚠️ 请求过于频繁</h1><p>您的请求速度超过了限制，请稍后再试。</p><p>如果您认为这是错误，请联系管理员。</p></body></html>';
    }
}
